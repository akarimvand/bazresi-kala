<?php
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Headers: Content-Type');

// ูุนุงูโุณุงุฒ ุฎุทุงุงุจ (ููุท ุฏุฑ ูุญุท ุชูุณุนู)
error_reporting(E_ALL);
ini_set('display_errors', 0); // ููุงุด ุฎุทุง ุฏุฑ ูุฑูุฑฺฏุฑ ุบุฑุถุฑูุฑ โ ุจูุชุฑ ุงุณุช ุฏุฑ ูุงฺฏ ุณุฑูุฑ ุจูุงูุฏ

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo json_encode(['success' => false, 'error' => 'Method Not Allowed'], JSON_UNESCAPED_UNICODE);
    exit;
}

$message = $_POST['message'] ?? '';
if (empty($message) || mb_strlen($message) > 3000) {
    echo json_encode(['success' => false, 'reply' => 'โ ูพุงู ูุงูุนุชุจุฑ ุง ุฎู ุทููุงู ุงุณุช.'], JSON_UNESCAPED_UNICODE);
    exit;
}

// โ๏ธ HIGHLIGHT: ุงูุฌุง ุญุฐู ุดุฏ! htmlspecialchars(strip_tags) ูุฎุฑุจ ุงุณุช โ LLM ูุงุฒ ุจู ูุชู ุฎุงู ุฏุงุฑุฏ!
// $message = htmlspecialchars(strip_tags($message), ENT_QUOTES, 'UTF-8'); // โ ุญุฐู ุดุฏ!

$api_key = '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'; // ๐ ุฌุงฺฏุฒู ฺฉูุฏ ุจุง ฺฉูุฏ ุฌุฏุฏ ุจุนุฏ ุงุฒ ูููุถ ฺฉุฑุฏู ูุฏู!
if (empty(trim($api_key))) {
    error_log("API Key is missing or empty.");
    echo json_encode([
        'success' => false,
        'reply' => 'โ๏ธ ุฎุทุง ุฏุงุฎู: ฺฉูุฏ API ุชูุธู ูุดุฏู ุงุณุช.'
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

$system_prompt = "
ุดูุง ฺฉ ูุชุฎุตุต ุจุงุฒุฑุณ ุตูุนุช ุจุง 25 ุณุงู ุชุฌุฑุจู ุฏุฑ ูพุฑูฺูโูุง ููุชุ ฺฏุงุฒุ ูพุชุฑูุดู ู ุงูุฑฺ ูุณุชุฏ. 
ุดูุง ุจู ุชูุงู ุงุณุชุงูุฏุงุฑุฏูุง ุจูโุงูููู ูุณูุท ูุณุชุฏุ ุงุฒ ุฌููู: 
ISO, ASME, API, ASTM, NACE, IEC, EN, DIN, JIS, AWS, SAES, SAMSS.

ูุธูู ุดูุง ุงู ุงุณุช ฺฉู ูพุณ ุงุฒ ุจุฑุฑุณ ุฏูู ุงุทูุงุนุงุช ุงุฑุณุงูุ ฺฉ **ฺฏุฒุงุฑุด ูู ุญุฑููโุงุ ุฏูู ู ูุงุจู ุงุณุชูุงุฏ** ุชูู ฺฉูุฏ.

ูุญู ู ุณุงุฎุชุงุฑ ูพุงุณุฎ ุจุงุฏ ุฏููุงู ูุทุงุจู ููููู ุฒุฑ ุจุงุดุฏ:

---
ุจู ุนููุงู ฺฉ ูุชุฎุตุต ุจุงุฒุฑุณ ุตูุนุชุ ุจุง ุชูุฌู ุจู ุงุทูุงุนุงุช ุงุฑุงุฆูโุดุฏู ุฏุฑ ููุฑุฏ (ูุซูุงู: ูููู ูููุงุฏ ุจุฏูู ุฏุฑุฒุ ูุทุฑ 12 ุงูฺุ ุถุฎุงูุช 12.7 ููโูุชุฑุ ุฌูุณ API 5L X65ุ ููุฑุฏ ุงุณุชูุงุฏู ุฏุฑ ุฎุท ูููู ุงูุชูุงู ฺฏุงุฒ)ุ ุงุฑุฒุงุจ ูู ุงููู ุฑุง ุงูุฌุงู ูโุฏูู. ููู ุงุณุช ุชุฃฺฉุฏ ฺฉูู ฺฉู ุงู ฺฏุฒุงุฑุด ุตุฑูุงู ุฌูุจู ุขููุฒุด ู ุฑุงูููุง ุฏุงุฑุฏ ู ุฌุงฺฏุฒู ุจุงุฒุฑุณ ูุฒฺฉ ู ูุณุชูุฏุงุช ุฑุณู ููโุดูุฏ.

๐ ุงุณุชุงูุฏุงุฑุฏูุง ูุฑุชุจุท ู ุงูุฒุงูุงุช ุจุงุฒุฑุณ:

ASME B31.3 - Process Piping

ุจุงุฒุฑุณ ู ุขุฒููู: ุจุงุฏ ุชูุงู ุฌูุดโูุง ุชุญุช ุขุฒูููโูุง NDT ูุฑุงุฑ ฺฏุฑูุฏ. ุญุฏุงูู 10ูช ุงุฒ ุงุชุตุงูุงุช ุฌูุด ุจุงุฏ ุจุง ุฑุงุฏูฺฏุฑุงู (RT) ุง ูุฑุงุตูุช (UT) ุจุงุฒุฑุณ ุดููุฏ. ุจุฑุง ุฎุทูุท ฺฉูุงุณ 1Aุ 100ูช RT ุงูุฒุงู ุงุณุช.
ุจุงุฒุฑุณ ุจุตุฑ (VT): ูุจู ุงุฒ ูุฑ ููุน ุขุฒููู ุบุฑูุฎุฑุจุ ุจุงุฒุฑุณ ุจุตุฑ ฺฉุงูู ุงุฒ ุณุทุญ ุฌูุดุ ุนุฏู ูุฌูุฏ ุชุฑฺฉุ ูููุฐ ูุงูุตุ ู ุงุดฺฉุงูุงุช ุณุทุญ ุงูุฒุงู ุงุณุช.
ุขุฒููู ูุดุงุฑ (Hydrotest): ูุดุงุฑ ุขุฒููู ุจุงุฏ 1.5 ุจุฑุงุจุฑ ูุดุงุฑ ุทุฑุงุญ ุจุงุดุฏ ู ุญุฏุงูู ุจู ูุฏุช 2 ุณุงุนุช ุญูุธ ุดูุฏ.

API 5L - Specification for Line Pipe

ฺฉูุชุฑู ููุงุฏ: ฺฏูุงู ูู (Mill Certificate) ุจุงุฏ ูุทุงุจู ุจุง ฺฏูุงู MTR ููุน 3.1B ุง 3.2 ุจุงุดุฏ ู ุดุงูู ูุชุงุฌ ุขุฒูููโูุง ุดูุง (C, Mn, Si, S, P) ู ูฺฉุงูฺฉ (Tensile, Hardness, Charpy V-notch) ุจุงุดุฏ.
ุจุงุฒุฑุณ ุงุจุนุงุฏ: ุงูุฏุงุฒูโฺฏุฑ ูุทุฑ ุฎุงุฑุฌุ ุถุฎุงูุช ุฏูุงุฑูุ ุงูุญูุง ุงูุชูุง ูููู ู ุตุงู ุณุทุญ ุจุงุฏ ูุทุงุจู ุจุง ุฏุณุชูุฑุงูุนูู ูุฑ ูพุฑูฺู ุจุงุดุฏ.

NACE MR0175 / ISO 15156

ุจุฑุง ูุญุทโูุง ุญุงู H2Sุ ุฌูุณ ูููู ู ุงุชุตุงูุงุช ุจุงุฏ ููุงูู ุฏุฑ ุจุฑุงุจุฑ ุชุฑฺฉโุฎูุฑุฏฺฏ ูุงุด ุงุฒ ุชูุด (SCC) ุจุงุดูุฏ. ุณุฎุช ูุฌุงุฒ ุจุฑุง ูููุงุฏูุง ฺฉุฑุจู ูุจุงุฏ ุงุฒ 22 HRC ุชุฌุงูุฒ ฺฉูุฏ.

ุชูุตูโูุง ุจุงุฒุฑุณ:

- ุชูู ุจุฑูุงูู ุจุงุฒุฑุณ (ITP) ุดุงูู ููุงุท ฺฉูุชุฑู (Hold Point, Witness Point).
- ุงุณุชูุงุฏู ุงุฒ ุชู ุจุงุฒุฑุณ ูุณุชูู ู ุฏุงุฑุง ฺฏูุงูโูุง ูุนุชุจุฑ (ูุซู CSWIPุ BGASุ ASNT Level II).
- ุซุจุช ฺฉุงูู ูุณุชูุฏุงุช ุจุงุฒุฑุณ (Checklists, NDT Reports, Calibration Certificates).

ุงุฑุฌุงุน ุจู ุชุฎุตุตโูุง ูุฑุชุจุท:

- ูุชุฎุตุต ุฌูุดฺฉุงุฑ (Welding Engineer) ุจุฑุง ุจุฑุฑุณ WPS/PQR.
- ูุชุฎุตุต NDT ุจุง ฺฏูุงู ุจูโุงูููู.
- ูููุฏุณ ููุงุฏ ุจุฑุง ุงุฑุฒุงุจ ููุงููุช ุฎูุฑุฏฺฏ.
---

ุฏุณุชูุฑุงูุนูู ุฏูู:
1. ุจุง ุฌููู ยซุจู ุนููุงู ฺฉ ูุชุฎุตุต ุจุงุฒุฑุณ ุตูุนุชุ ุจุง ุชูุฌู ุจู ุงุทูุงุนุงุช ุงุฑุงุฆูโุดุฏู ุฏุฑ ููุฑุฏ (...)ยป ุดุฑูุน ฺฉู.
2. ุญุชูุงู ูุดุฏุงุฑ ุฏูุฏ: ยซุงู ฺฏุฒุงุฑุด ุตุฑูุงู ุฌูุจู ุขููุฒุด ู ุฑุงูููุง ุฏุงุฑุฏ ู ุฌุงฺฏุฒู ุจุงุฒุฑุณ ูุฒฺฉ ู ูุณุชูุฏุงุช ุฑุณู ููโุดูุฏ.ยป
3. ุงุฒ ุจุฎุด ยซ๐ ุงุณุชุงูุฏุงุฑุฏูุง ูุฑุชุจุท ู ุงูุฒุงูุงุช ุจุงุฒุฑุณ:ยป ุงุณุชูุงุฏู ฺฉู.
4. ูุฑ ุงุณุชุงูุฏุงุฑุฏ ุง ุงูุฒุงู ุฑุง ุจู ุตูุฑุช ุฌุฏุงฺฏุงูู ุจููุณุฏ ู ุฒุฑุจุฎุดโูุง ุฒุฑ ุฑุง ุฏุงุดุชู ุจุงุดุฏ:
   - ุจุงุฒุฑุณ ู ุขุฒููู
   - ุจุงุฒุฑุณ ุจุตุฑ (VT)
   - ุขุฒููู ูุดุงุฑ (Hydrotest)
   - ฺฉูุชุฑู ููุงุฏ (MTR)
   - ุงูุฒุงูุงุช ูุญุท (ูุซู H2S)
5. ุงุฒ ุฒุจุงู ูุงุฑุณ ุฑุณูุ ูู ู ุญุฑููโุง ุงุณุชูุงุฏู ฺฉู.
6. ุงุฒ ุนูุงูุชโูุง ุงุถุงู (ูุซู ###ุ **ุ ---) ุงุณุชูุงุฏู ูฺฉู.
7. ูพุงุณุฎ ุญุฏุงูู 400 ฺฉููู ุจุงุดุฏ ู ุจุณุงุฑ ุฏููุ ูู ู ุนูู ุจุงุดุฏ.
8. ุฏุฑ ูพุงุงูุ ุชูุตูโูุง ุจุงุฒุฑุณ ู ุงุฑุฌุงุน ุจู ุชุฎุตุตโูุง ูุฑุชุจุท ุฑุง ุงุฑุงุฆู ุฏูุฏ.
";

$payload = json_encode([
    "model" => "deepseek/deepseek-chat",
    "messages" => [
        ["role" => "system", "content" => $system_prompt],
        ["role" => "user", "content" => $message]
    ],
    "temperature" => 0.5,
    "max_tokens" => 1200
]);

$ch = curl_init();
curl_setopt_array($ch, [
    CURLOPT_URL => "https://openrouter.ai/api/v1/chat/completions", // โ ุงุตูุงุญ ุดุฏู: ุญุฐู ูุถุงูุง ุฎุงู
    CURLOPT_POST => true,
    CURLOPT_POSTFIELDS => $payload,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_HTTPHEADER => [
        "Authorization: Bearer $api_key",
        "Content-Type: application/json",
        "User-Agent: SAPRABOT/1.0"
    ],
    CURLOPT_TIMEOUT => 45,
    CURLOPT_SSL_VERIFYPEER => true
]);

$response = curl_exec($ch);
$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$error = curl_error($ch);
curl_close($ch);

if ($http_code === 200 && $response) {
    $data = json_decode($response, true);
    if (isset($data['choices'][0]['message']['content'])) {
        $reply = $data['choices'][0]['message']['content'];
        $reply = strip_tags($reply); // ุญุฐู ุชฺฏโูุง HTML
        $reply = preg_replace('/#{1,}|[*]{2,}|^- /', '', $reply); // ุญุฐู markdown
        echo json_encode(['success' => true, 'reply' => trim($reply)], JSON_UNESCAPED_UNICODE);
    } else {
        error_log("OpenRouter Response malformed: " . print_r($data, true));
        echo json_encode([
            'success' => false,
            'reply' => 'โ๏ธ ูพุงุณุฎ ุณุฑูุฑ ูุงูุนุชุจุฑ ุงุณุช. ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.'
        ], JSON_UNESCAPED_UNICODE);
    }
} else {
    error_log("OpenRouter API Error: HTTP $http_code | cURL Error: $error | Response: $response");
    echo json_encode([
        'success' => false,
        'reply' => 'โ๏ธ ุณุฑูุณ ูููุชุงู ุฏุฑ ุฏุณุชุฑุณ ูุณุช. ูุทูุงู ุจุนุฏุงู ุชูุงุด ฺฉูุฏ.'
    ], JSON_UNESCAPED_UNICODE);
}
